<!DOCTYPE html>
<html>
  <head>
    <title>Play!</title>
    <%= javascript_include_tag 'i18n' %>
    <%= javascript_include_tag 'translations' %>
    <%= javascript_include_tag 'dummy_game' %>
    <%= load_global8ball_game %>
    <script type="text/javascript">
      function parseGetCurrentState(e) {
        var config = <%= raw @game.config %>;

        ball_positions = {};
        ball_positions['PlayForBegin'] = <%= raw Global8ballGame::BallPosition.config_json "PlayForBegin" %>;
        ball_positions['PlayForBegin'].balls[0].owner = config.player_1.user_id;
        ball_positions['PlayForBegin'].balls[1].owner = config.player_2.user_id;

        ball_positions['PlayForVictory'] = <%= raw Global8ballGame::BallPosition.config_json "PlayForVictory" %>;
        var current_breaker_select = document.getElementById('current_breaker');
        var current_breaker = parseInt(current_breaker_select.options[current_breaker_select.selectedIndex].value);
        ball_positions['PlayForVictory'].balls[0].owner = current_breaker;

        ball_positions['ShowResult'] = {};

        options = {
          current_stage: {
            stage_name: window.current_stage,
            round: 0
          },
          balls: ball_positions[window.current_stage].balls
        };

        if (window.current_stage == 'PlayForVictory') {
          options.current_players = [
            { user_id: current_breaker }
          ];
        }

        if (window.current_stage == 'PlayForBegin') {
          options.current_players = [
            { user_id: config.player_1.user_id },
            { user_id: config.player_2.user_id }
          ];
        }

        window.game.events.onSetState.dispatch(options);
      };
    </script>
    <style type="text/css">
      html {
        font: bold 24px Arial;
      }
      .button {
        text-decoration: none;
        background-color: #EEEEEE;
        color: #333333;
        padding: 2px 6px 2px 6px;
        border-top: 1px solid #CCCCCC;
        border-right: 1px solid #333333;
        border-bottom: 1px solid #333333;
        border-left: 1px solid #CCCCCC;
      }
      .menu select {
      }
      .menu_right {
        float: right;
      }
      #da-game {
        height:105vh;
        width:140vh;
      }
    </style>
  </head>
  <body>
    <div id="menu_top" class="menu">
      <p>Select the current viewer: <%= current_viewer_select %></p>
      <p>Select the current stage: <%= current_stage_select%></p>
      <p id="breaker" style="display: none;">Select who breaks: <%= current_break_select%></p>
      <%= link_to "Let's play", "#", id: "lets_play", class: "button", onclick: "loadGame(#{@game.config});" %>
    </div>
    <div id="menu_right" class="menu menu_right" style="display: none;">
      <a href="#" id="reload" class="button" onclick="window.location = '/';">Reload</a>
    </div>
    <div id="da-game"></div>
  </body>
  <script type="text/javascript">
    var elem = document.getElementById('current_stage');
    elem.addEventListener('change', parseCurrentStage, false);
  </script>
</html>
